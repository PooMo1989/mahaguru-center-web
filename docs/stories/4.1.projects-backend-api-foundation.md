# Story 4.1: Projects Backend API Foundation (Revised)

## Status
Done

## Story
**As a** administrator,
**I want** a backend system and API for Projects so that I can manage project and donation data.

## Acceptance Criteria
1. A database table/collection for "Projects" must be created.
2. The Project data model must include all required fields: `ProjectName`, `Description`, `DonationGoalAmount`, `CurrentDonationAmount`, `ProjectType`, `ProjectNature`, `StartDate`, `EndDate`, `donationLinkTarget`, and `photos`.
3. The Project data model must support all four specific projects from the Project Brief: "Our Digital Mission", "Arahathmaga Spiritual Center", "The AI Guru", and "Beyond Words".
4. All CRUD endpoints (Create, Read, Update, Delete) must be functional.
5. All API endpoints must be verified with automated tests.

## Tasks / Subtasks
- [x] **ANALYSIS: Review existing admin portal infrastructure** (Epic Consolidation Analysis)
  - [x] Analyze existing admin portal at `/admin` route structure and authentication
  - [x] Document current admin components: EventList, EventForm, ConfirmationDialog
  - [x] Review admin layout patterns and shared authentication infrastructure
  - [x] Identify reusable patterns for unified admin portal approach
  - [x] Remove any unnecessary duplicate admin infrastructure from future stories
  - [x] **KEY FINDING**: Existing admin portal at `/admin` provides perfect foundation - Story 4.2 should integrate Projects as tabs, NOT create separate `/admin/projects/` route
- [x] Create input validation schemas using Zod (AC: 2, 3)
  - [x] Define `projectCreateInput` schema with all required fields
  - [x] Define `projectUpdateInput` schema with optional fields
  - [x] Define `projectFilterInput` schema for query filtering
  - [x] Ensure DECIMAL validation for donation amounts
  - [x] Validate projectNature enum values ('Continuous', 'One-time')
  - [x] Validate donationLinkTarget enum values ('Daily Dana', 'Poya Day', 'Special Projects')
- [x] Update Prisma schema to include Project model (AC: 1, 2, 3)
  - [x] Add Project model to `prisma/schema.prisma` with all required fields
  - [x] Include additional field `donationLinkTarget` as specified in database schema
  - [x] Include `photos` field as TEXT[] for project images
  - [x] Add proper TypeScript types for DECIMAL fields (donationGoalAmount, currentDonationAmount)
  - [x] Run `npx prisma db push` to apply schema changes to database
  - [x] Generate Prisma client with `npx prisma generate`
- [x] Create tRPC Project router with CRUD operations (AC: 4)
  - [x] Create `src/server/api/routers/project.ts` following Event router patterns
  - [x] Implement `getProjects` query for fetching all projects
  - [x] Implement `getProject` query for fetching single project by ID
  - [x] Implement `createProject` mutation with input validation
  - [x] Implement `updateProject` mutation with input validation
  - [x] Implement `deleteProject` mutation with proper error handling
  - [x] Add Project router to main router in `src/server/api/root.ts`
- [x] Write comprehensive test suite for API endpoints (AC: 5)
  - [x] Test Project creation with valid data for all four Project Brief projects
  - [x] Test Project creation with invalid data (validation errors)
  - [x] Test Project retrieval (single and multiple)
  - [x] Test Project updates (partial and full)
  - [x] Test Project deletion
  - [x] Test edge cases (non-existent IDs, malformed requests)

## Dev Notes

### CRITICAL ANALYSIS: Unified Admin Portal Architecture

**üîç Admin Portal Infrastructure Review** (Epic Consolidation Analysis):

**Existing Admin Foundation** (Epic 3 - Events):
- **Unified Admin Portal**: Single entry point at `/admin` route with shared authentication
- **Admin Layout**: `src/app/admin/layout.tsx` - Handles authentication, header, navigation
- **Main Admin Page**: `src/app/admin/page.tsx` - Event management integrated into main portal
- **Shared Components**: EventList, EventForm, ConfirmationDialog in `src/components/admin/`
- **Authentication**: NextAuth.js with server-side protection and user session management

**Key Architecture Insight**: The existing admin portal provides a perfect **unified foundation** that should be extended with tabbed navigation rather than creating separate admin portals.

**Epic 4 Strategy - Unified Approach**:
- ‚úÖ **Story 4.1** (This story): API foundation only - no admin UI changes needed
- ‚ö†Ô∏è **Story 4.2**: Must be **completely revised** to integrate Projects into existing `/admin` portal
- üéØ **Target Architecture**: Add "Events | Projects" tabs to existing admin page
- üö´ **Avoid**: Creating separate `/admin/projects/` route or duplicate admin infrastructure

**Shared Infrastructure to Leverage**:
- Admin authentication and layout (already built)
- tRPC integration patterns from Events router
- Form validation patterns with Zod schemas
- Confirmation dialog component for delete operations
- Admin styling and responsive design patterns

**Impact on Future Stories**:
- Story 4.2 will focus on **tab integration** rather than separate portal creation
- Story 4.2 will reuse existing admin components and patterns
- No duplicate authentication or layout infrastructure needed

### Previous Story Insights
Stories 3.1-3.4 have successfully implemented the complete Events backend API foundation and frontend components. The Event model demonstrates successful patterns for:
- tRPC router structure with proper TypeScript integration
- Prisma schema design with proper field types and constraints
- CRUD operation implementation with input validation using Zod
- Test suite organization for API endpoint verification
- Frontend integration patterns using tRPC client
The Project model should follow identical architectural patterns established in the Event implementation. [Source: docs/stories/3.1.events-backend-api-foundation.md, docs/stories/3.4.frontend-events-page-automated-filtering.md]

### Data Models
**Project Model Structure** (From Database Schema):
- `id`: Primary key (TEXT, required)
- `projectName`: Project name (TEXT, NOT NULL)
- `description`: Project description (TEXT, NOT NULL)
- `photos`: Array of photo URLs (TEXT[])
- `donationGoalAmount`: Target donation amount (DECIMAL(65,30), NOT NULL)
- `currentDonationAmount`: Current raised amount (DECIMAL(65,30), NOT NULL)
- `projectType`: Type of project (TEXT, NOT NULL)
- `projectNature`: Project duration type (TEXT, NOT NULL) - Values: 'Continuous'/'One-time'
- `startDate`: Project start date (TIMESTAMP(3), nullable)
- `endDate`: Project end date (TIMESTAMP(3), nullable)
- `donationLinkTarget`: Target donation category (TEXT, NOT NULL) - Values: 'Daily Dana', 'Poya Day', 'Special Projects'
- `createdAt`: Creation timestamp (TIMESTAMP(3), auto-generated)
- `updatedAt`: Update timestamp (TIMESTAMP(3), auto-generated)
[Source: architecture/9-database-schema.md#Projects Table]

### API Specifications
**tRPC Project Router** (Following Event Router patterns):
- Router location: `src/server/api/routers/project.ts`
- Integration: Add to main router in `src/server/api/root.ts`
- Endpoints required:
  - `getProjects`: Query for retrieving all projects
  - `getProject`: Query for retrieving single project by ID
  - `createProject`: Mutation for creating new project
  - `updateProject`: Mutation for updating existing project
  - `deleteProject`: Mutation for deleting project
- Must follow tRPC patterns established in Event router implementation
[Source: architecture/5-api-specification.md#Project Router, docs/stories/3.1.events-backend-api-foundation.md]

### Component Specifications
**Backend API Foundation Only**: No frontend components required for this story. The Project tRPC router will be consumed by the unified admin portal in Story 4.2.

**For Story 4.2 Integration**: The Project router follows identical patterns to the Event router, making integration seamless:
- Same tRPC query/mutation patterns for easy admin portal integration
- Consistent Zod validation schemas for form handling
- Compatible TypeScript types for admin component development
- Follows established CRUD operation conventions

**Unified Admin Portal Plan**: Story 4.2 will integrate Project management into the existing `/admin` portal with tabbed navigation (Events | Projects) rather than creating a separate admin portal. This story provides the API foundation that supports this unified approach.

[Source: prd/5-epic-story-breakdown.md#Epic 4 Overview, Epic Consolidation Analysis]

### Content and Structure Requirements
**Required Project Content Structure** (From Project Brief):
The data model must support the four specific projects defined in the Project Brief:

**Project 1: "Our Digital Mission"**
- **Description**: "Our Digital Mission is to create a comprehensive digital sanctuary that preserves and shares over two decades of authentic Dhamma teachings. Supported by a dedicated team of staff and volunteers, this project ensures timeless wisdom is accessible to all. The mission is composed of four key pillars: the **Web Archive**, a complete online platform organizing our spiritual wisdom; a **Video Archive** on our YouTube Channel with extensive Dhamma discussions; a thriving **Facebook Community** for daily inspiration; and a collection of **Key Publications** featuring our most essential teachings."
- **ProjectType**: "Digital Infrastructure"
- **ProjectNature**: "Continuous"
- **DonationLinkTarget**: "Special Projects"

**Project 2: "Arahathmaga Spiritual Center"**
- **Description**: "The Arahathmaga Spiritual Center is our physical sanctuary, a peaceful environment where seekers can practice meditation, meet with experienced spiritual facilitators, and spend quality time in contemplation and learning. It is a place to access direct guidance from Mahaguru and our dedicated full-time team. To keep our doors open and our services free, we rely on the generosity of our community. Your support helps us cover our essential monthly expenses."
- **ProjectType**: "Physical Infrastructure"
- **ProjectNature**: "Continuous"
- **DonationGoalAmount**: 750000 (LKR monthly goal per FR5)
- **DonationLinkTarget**: "Daily Dana"
- **Special Requirements**: Must display visual list of monthly expenses with photos and donation progress bar (per Project Brief functional requirements)

**Project 3: "The AI Guru"**
- **Description**: "We are developing **The AI Guru**, a revolutionary project to transform our vast digital archive from a static repository into a dynamic, interactive spiritual partner. Using sophisticated AI, we are creating an intelligent guide that allows anyone to ask complex questions in natural language and receive clear, contextual answers drawn directly from the authentic Dhamma teachings. This project makes profound wisdom instantly accessible and personalized."
- **ProjectType**: "Technology Development"
- **ProjectNature**: "One-time"
- **DonationLinkTarget**: "Special Projects"

**Project 4: "Beyond Words"**
- **Description**: "The **Beyond Words** initiative is a visionary project centered on the sacred 'Maithri Bodhi' text. Our goal is to go beyond literal translation and use language itself as a tool for liberation. We aim to capture the subtle vibration and transformative power of the original teachings, creating a version of the text that conveys not just meaning, but the very essence of the Dhamma."
- **ProjectType**: "Publication/Translation"
- **ProjectNature**: "One-time"
- **DonationLinkTarget**: "Special Projects"

[Source: docs/Project-Brief.md#Page 4: Projects Page, docs/prd/2-requirements.md#FR5, FR7, FR8]

### File Locations
- **Prisma Schema**: `prisma/schema.prisma` - Add Project model [Source: architecture/10-source-tree.md]
- **Project Router**: `src/server/api/routers/project.ts` - tRPC router implementation [Source: architecture/10-source-tree.md]
- **Main Router**: `src/server/api/root.ts` - Add Project router to exports [Source: architecture/10-source-tree.md]
- **Test Files**: `src/test/` directory - API endpoint tests [Source: architecture/14-test-strategy-and-standards.md]

### Testing Requirements
**Test Strategy**: Vitest for unit and integration testing with 80% coverage target for critical logic
- API endpoint testing for all CRUD operations
- Input validation testing with Zod schemas
- Database integration testing with Prisma
- Error handling and edge case testing
- Mock database setup for isolated testing
**Test File Location**: Tests should be in `src/test/` directory following Event router test patterns
[Source: architecture/14-test-strategy-and-standards.md]

### Technical Constraints
- **TypeScript Strict Mode**: All API code must have proper type safety with Project model types [Source: architecture/13-coding-standards.md]
- **Prisma ORM**: All database access must use Prisma client - no raw SQL [Source: architecture/13-coding-standards.md]
- **tRPC Framework**: All API endpoints must use tRPC router patterns for type safety [Source: architecture/2-tech-stack.md]
- **Input Validation**: All mutations must use Zod schemas for input validation [Source: architecture/13-coding-standards.md]
- **DECIMAL Handling**: Use Prisma Decimal type for monetary amounts (donationGoalAmount, currentDonationAmount) [Source: architecture/9-database-schema.md]
- **Date Handling**: startDate/endDate are optional TIMESTAMP(3) fields - handle null values properly [Source: architecture/9-database-schema.md]

### Testing
**Testing Standards from Architecture**:
- **Test Framework**: Vitest for unit and integration tests [Source: architecture/2-tech-stack.md]
- **Coverage Target**: 80% code coverage for critical logic [Source: architecture/14-test-strategy-and-standards.md]
- **Test File Location**: `src/test/` directory following existing patterns [Source: architecture/14-test-strategy-and-standards.md]
- **Test Types**: API endpoint testing, input validation, database integration, error handling [Source: architecture/14-test-strategy-and-standards.md]
- **Testing Patterns**: Mock Prisma client, test CRUD operations, verify Zod validation [Source: architecture/14-test-strategy-and-standards.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial story creation with comprehensive technical context | Bob (Scrum Master) |
| 2025-09-20 | 1.1 | Added specific Project Brief content requirements and acceptance criteria for four required projects | Bob (Scrum Master) |
| 2025-09-20 | 1.2 | Fixed acceptance criteria issues: Updated AC 2 to include all required fields (donationLinkTarget, photos), consolidated redundant CRUD ACs, improved task sequencing | Sarah (Product Owner) |
| 2025-09-21 | 1.3 | **EPIC CONSOLIDATION ANALYSIS**: Added critical analysis task to review existing admin portal infrastructure and prevent duplicate admin portals. Key finding: Story 4.2 should integrate into existing `/admin` portal with tabs, not create separate `/admin/projects/` route | Sarah (Product Owner)

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
James (dev) - Full Stack Developer

### Debug Log References

### Completion Notes List
- Successfully implemented Prisma Project model with all required fields including DECIMAL types for donation amounts
- Created comprehensive Zod validation schemas with proper enum validation and date constraints  
- Implemented full tRPC CRUD router following Event router patterns with proper TypeScript types
- Added Project router to main tRPC router configuration
- Created comprehensive test suite with 19 test cases covering all Project Brief requirements
- All tests passing with validation for the four specific projects from Project Brief
- TypeScript compilation successful with no errors

### File List
- `prisma/schema.prisma` - Added Project model with DECIMAL fields and proper indexing
- `src/server/api/routers/project.ts` - Complete tRPC router with CRUD operations and validation
- `src/server/api/root.ts` - Updated to include Project router
- `src/test/projects-integration.test.ts` - Comprehensive test suite with 19 test cases

## QA Results

### Review Date: September 20, 2025

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**EXCELLENT IMPLEMENTATION** - This story represents a high-quality backend API foundation that closely follows established architectural patterns from the Event router implementation. The Project router demonstrates solid adherence to coding standards with proper TypeScript types, comprehensive input validation, and well-structured tRPC patterns.

**Key Strengths:**
- **Complete Requirements Coverage**: All 5 acceptance criteria fully met with supporting implementation
- **Robust Data Model**: Proper Prisma schema with DECIMAL fields for monetary amounts and comprehensive indexing
- **Type Safety**: Full TypeScript integration with proper Zod schemas and Prisma types
- **Comprehensive Testing**: 19 test cases covering all Project Brief requirements, validation scenarios, and edge cases
- **Architectural Consistency**: Perfect alignment with Event router patterns and project conventions

### Refactoring Performed

No refactoring was necessary. The implementation demonstrates excellent code quality and follows all established patterns correctly.

### Compliance Check

- **Coding Standards**: ‚úì Full TypeScript strict mode compliance, proper tRPC patterns, Prisma-only data access
- **Project Structure**: ‚úì Correct file placement following established source tree organization  
- **Testing Strategy**: ‚úì Vitest integration tests with 100% requirement coverage exceeding 80% target
- **All ACs Met**: ‚úì All 5 acceptance criteria fully implemented and verified

### Improvements Checklist

All items completed during development - no remaining improvements needed:

- [x] Complete Project model with all required fields (AC 1, 2)
- [x] Support for all four Project Brief projects (AC 3)  
- [x] Full CRUD router implementation (AC 4)
- [x] Comprehensive test suite with 19 test cases (AC 5)
- [x] Proper DECIMAL handling for donation amounts
- [x] Enum validation for projectNature and donationLinkTarget
- [x] Date constraint validation (end date after start date)
- [x] URL validation for photos array
- [x] Error handling for non-existent IDs
- [x] Integration with main tRPC router

### Security Review

**PASS** - No security concerns identified:
- All mutations properly use `protectedProcedure` (admin-only operations)
- Public queries appropriately use `publicProcedure` for read operations
- Input validation prevents injection attacks through Zod schemas
- Database access exclusively through Prisma ORM (no raw SQL)

### Performance Considerations

**EXCELLENT** - Performance optimizations properly implemented:
- Database indexes on `projectNature` and `donationLinkTarget` for efficient filtering
- Proper use of `orderBy` for consistent data retrieval
- Decimal precision handling optimized for monetary calculations
- Efficient filtering logic avoiding N+1 queries

### Files Modified During Review

No files modified during review - implementation was complete and correct.

### Gate Status

Gate: **PASS** ‚Üí docs/qa/gates/4.1-projects-backend-api-foundation.yml

### Recommended Status

‚úì **Ready for Done** - All acceptance criteria met, comprehensive test coverage achieved, no blocking issues identified. This implementation provides a solid foundation for future Project management features.