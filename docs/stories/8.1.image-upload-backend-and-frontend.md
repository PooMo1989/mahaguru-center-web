# Story 8.1: Image Upload Backend Foundation & Frontend Interface

## Status
In Progress

## Story
**As an** admin user,
**I want** to upload multiple images directly to the database through the admin panel while creating or editing an event or a project,
**so that** I can manage content images efficiently, designate one as the featured image for better content presentation, and remove unwanted images as needed.

## Acceptance Criteria
1. A database table for "Images" with proper foreign key relationships to Events and Projects must be created
2. Each image must be linked to either an Event OR a Project through foreign key relationships (eventId or projectId)
3. Database constraints must ensure only one featured image exists per Event/Project
4. Admin can upload multiple images via drag & drop or file selection during create/edit operations
5. Images are validated for type (JPEG, PNG, WEBP) and size (max 5MB) before upload
6. Uploaded images are stored with metadata: filename, original name, mime type, size, path, URL
7. Admin can preview all uploaded images for an Event/Project in a responsive grid layout
8. Admin can designate one image as "featured" and change the selection at any time
9. Admin can delete individual images with confirmation
10. When an Event/Project is deleted, all associated images are automatically deleted (cascade delete)
11. Backward compatibility maintained with existing `photos: String[]` fields
12. All API endpoints must be verified with automated tests
13. Upload progress indicator shown during file uploads
14. Error handling for failed uploads with user-friendly messages

## Tasks / Subtasks
- [ ] Create Image data model and database schema (AC: 1, 2, 3, 10, 11)
  - [ ] Define Image model in Prisma schema with all required fields
  - [ ] Add foreign key relationships (eventId, projectId) with optional fields
  - [ ] Add cascade delete behavior for data integrity
  - [ ] Add unique constraints for featured images per entity
  - [ ] Add relationship fields to Event and Project models
  - [ ] Run database migration to create Image table
- [ ] Implement tRPC Image Router with CRUD operations (AC: 5, 6, 8, 9, 12)
  - [ ] Create image router file in src/server/api/routers/
  - [ ] Implement uploadImage mutation with file validation
  - [ ] Implement getEntityImages query for retrieving images
  - [ ] Implement setFeaturedImage mutation with transaction logic
  - [ ] Implement deleteImage mutation with storage cleanup
  - [ ] Implement getFeaturedImage query
  - [ ] Add image router to main tRPC router
- [ ] Implement file storage handling (AC: 4, 5, 6)
  - [ ] Set up file storage solution (Vercel Blob recommended)
  - [ ] Implement file upload with progress tracking
  - [ ] Add file type and size validation
  - [ ] Generate unique filenames to prevent collisions
  - [ ] Store file metadata in database
- [ ] Create ImageUpload component (AC: 4, 7, 13, 14)
  - [ ] Implement drag & drop file upload UI
  - [ ] Add file preview with thumbnails
  - [ ] Display upload progress indicator
  - [ ] Show validation errors to users
  - [ ] Implement responsive grid layout
- [ ] Implement image management UI (AC: 7, 8, 9)
  - [ ] Create image preview grid with thumbnails
  - [ ] Add "Set Featured" button for non-featured images
  - [ ] Add "Featured" badge for featured image
  - [ ] Add "Delete" button with hover overlay
  - [ ] Implement delete confirmation dialog
- [ ] Integrate with EventForm and ProjectForm (AC: 4, 11)
  - [ ] Replace URL input with ImageUpload component in EventForm
  - [ ] Replace URL input with ImageUpload component in ProjectForm
  - [ ] Maintain backward compatibility with photos field
  - [ ] Handle form submission with image data
- [ ] Write comprehensive test suite (AC: 12)
  - [ ] Test Image model relationships and constraints
  - [ ] Test uploadImage endpoint with valid/invalid files
  - [ ] Test getEntityImages query filtering
  - [ ] Test setFeaturedImage mutation and uniqueness constraint
  - [ ] Test deleteImage endpoint and cascade behavior
  - [ ] Test ImageUpload component rendering and interactions
  - [ ] Test form integration with EventForm and ProjectForm
  - [ ] Test error handling scenarios

## Dev Notes

### Previous Story Insights
Stories 3.1-3.4 successfully implemented the Events backend API with tRPC and Prisma patterns. Stories 4.1-4.2 extended this pattern for Projects. Both Events and Projects currently use `photos: String[]` for URL-based image storage. This story introduces proper relational image management while maintaining backward compatibility. [Source: docs/stories/3.1.events-backend-api-foundation.md, docs/stories/4.1.projects-backend-api-foundation.md]

### Data Models
**Image Model Structure** (Required fields):
- `id`: Primary key (TEXT, @default(cuid()))
- `filename`: Generated storage filename (TEXT, NOT NULL)
- `originalName`: User's original filename (TEXT, NOT NULL)
- `mimeType`: File MIME type (TEXT, NOT NULL)
- `size`: File size in bytes (INTEGER, NOT NULL)
- `path`: Storage path (TEXT, NOT NULL)
- `url`: Public access URL (TEXT, NOT NULL)
- `alt`: Alt text for accessibility (TEXT, OPTIONAL)
- `eventId`: Foreign key to Event (TEXT, OPTIONAL)
- `projectId`: Foreign key to Project (TEXT, OPTIONAL)
- `isFeatured`: Featured flag (BOOLEAN, DEFAULT false)
- `uploadedBy`: User ID of uploader (TEXT, NOT NULL)
- `createdAt`: Creation timestamp (TIMESTAMP(3), DEFAULT now())
- `updatedAt`: Update timestamp (TIMESTAMP(3), @updatedAt)

**Relationships**:
- Image → Event (many-to-one, optional, cascade delete)
- Image → Project (many-to-one, optional, cascade delete)
- Event → Images (one-to-many)
- Project → Images (one-to-many)

**Constraints**:
- Unique constraint on (eventId, isFeatured) where isFeatured = true
- Unique constraint on (projectId, isFeatured) where isFeatured = true
- Indexes on eventId, projectId, isFeatured for query performance

### API Specifications
**tRPC Image Router**: Following established patterns from Event and Project routers
- Router location: `src/server/api/routers/image.ts`
- Must integrate with main router in `src/server/api/root.ts`
- **Required endpoints**:
  - `uploadImage`: Protected mutation for uploading images
  - `getEntityImages`: Public query for retrieving entity images
  - `setFeaturedImage`: Protected mutation for setting featured image
  - `deleteImage`: Protected mutation for deleting images
  - `getFeaturedImage`: Public query for featured image retrieval
[Source: architecture/5-api-specification.md]

### File Locations
**New Files**:
- `src/server/api/routers/image.ts` - tRPC Image Router
- `src/components/admin/image-upload.tsx` - ImageUpload component
- `src/components/admin/image-upload.test.tsx` - Component tests
- `src/server/api/routers/image.test.ts` - API endpoint tests
- `prisma/migrations/[timestamp]_add_image_model/migration.sql` - Database migration

**Modified Files**:
- `prisma/schema.prisma` - Add Image model, update Event and Project models
- `src/server/api/root.ts` - Register image router
- `src/components/admin/event-form.tsx` - Integrate ImageUpload component
- `src/components/admin/project-form.tsx` - Integrate ImageUpload component

### Technical Constraints
- **TypeScript Strict Mode**: All components and APIs must have proper type safety
- **File Upload Limits**: Max 5MB per file, only image types (JPEG, PNG, WEBP)
- **Prisma ORM**: All database access through Prisma client
- **tRPC Integration**: Type-safe client-server communication
- **Authentication**: Upload and delete operations require admin authentication
- **Database Constraints**: Enforce business rules at database level

### File Storage Solution
**Recommended**: Vercel Blob Storage
- Seamless integration with Next.js/Vercel deployment
- Built-in CDN for fast image delivery
- Simple API for upload/delete operations
- Automatic public URL generation

**Alternative Options**:
- AWS S3 (more configuration, higher flexibility)
- Local storage (development only, not recommended for production)

### Component Architecture
**ImageUpload Component Structure**:
- Uses `react-dropzone` for drag & drop functionality
- Integrates with tRPC mutations for upload/delete
- Displays responsive grid of uploaded images
- Shows upload progress and validation errors
- Provides featured image selection UI

**Form Integration Pattern**:
- Replace existing photo URL input sections
- Pass entityType and entityId to ImageUpload
- Handle form submission with image relationships
- Maintain existing photos field for backward compatibility

### Environment Variables
Add to `.env.local`:
```env
# Image upload configuration
MAX_FILE_SIZE=5242880
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/webp
UPLOAD_STORAGE_TYPE=vercel-blob

# Vercel Blob (if using)
BLOB_READ_WRITE_TOKEN=your_token_here
```

### Testing Strategy
**Unit Tests**:
- Prisma Image model relationships
- File validation logic
- Featured image uniqueness

**Integration Tests**:
- tRPC router endpoints
- File upload flow
- Cascade delete behavior

**Component Tests**:
- ImageUpload rendering
- Drag & drop interactions
- Featured image selection
- Delete confirmation

**End-to-End Tests**:
- Complete upload workflow in admin portal
- Image management in EventForm/ProjectForm
- Data integrity across operations

### Migration Strategy
1. Add Image model without removing photos fields
2. Both systems run in parallel during transition
3. Admin can use either URL or upload approach
4. Future cleanup story can remove photos fields if needed

## Dev Agent Record

### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes List
TBD

### File List
**New Files Created**:
- TBD

**Modified Files**:
- TBD

## QA Results

### Test Results Summary
TBD

### Requirements Traceability Analysis
TBD

### Files Modified During Review
TBD

### Gate Status
TBD
