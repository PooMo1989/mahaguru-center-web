# Story 3.1: Events Backend API Foundation

## Status
Done

## Story
**As an** administrator,
**I want** a basic backend system and API for Events,
**so that** I can programmatically create, read, update, and delete event data.

## Acceptance Criteria
1. A database table/collection for "Events" must be created.
2. The Event data model must include a mandatory **`EventDate`** (datetime) field.
3. API endpoints for creating, updating, and deleting events must be functional.
4. The API endpoint for reading events (`GET /api/events`) must support **filtering** by past or upcoming based on eventDate comparison with current timestamp.
5. The API endpoint for reading a single event must be functional.
6. All API endpoints must be verified with automated tests.
7. Event data model must support all required fields for frontend display: name, description, category, eventDate, and photos array.

## Tasks / Subtasks
- [x] Create Event data model and database schema (AC: 1, 2, 7)
  - [x] Define Event model in Prisma schema with required fields
  - [x] Add EventDate as mandatory datetime field
  - [x] Include fields for name, description, category, photos array
  - [x] Add createdAt and updatedAt timestamp fields
  - [x] Run database migration to create Event table
- [x] Implement tRPC Event Router with CRUD operations (AC: 3, 4, 5)
  - [x] Create event router file in src/server/api/routers/
  - [x] Implement createEvent mutation with input validation
  - [x] Implement updateEvent mutation with ID and data validation
  - [x] Implement deleteEvent mutation with ID validation
  - [x] Implement getEvents query with optional filtering (past/upcoming based on eventDate vs current timestamp)
  - [x] Implement getEvent query for single event by ID
  - [x] Add event router to main tRPC router
- [x] Write comprehensive test suite (AC: 6)
  - [x] Test createEvent endpoint with valid and invalid data
  - [x] Test updateEvent endpoint with various scenarios
  - [x] Test deleteEvent endpoint with valid and invalid IDs
  - [x] Test getEvents endpoint with filtering parameters (past/upcoming)
  - [x] Test getEvent endpoint for single event retrieval
  - [x] Test error handling for all endpoints
  - [x] Test eventDate filtering logic with current timestamp comparison

## Dev Notes

### Previous Story Insights
Previous stories in Epic 2 have successfully established the frontend infrastructure using Next.js 14+, TypeScript, and Tailwind CSS. The Contact Us page implementation demonstrated proper form handling and state management patterns that should inform frontend-backend integration in future stories. No backend infrastructure has been implemented yet - this is the first backend story requiring database and API development. [Source: Previous completed stories 2.1-2.4]

### Data Models
**Event Model Structure** (Required fields):
- `id`: Primary key (TEXT)
- `name`: Event name (TEXT, NOT NULL)
- `description`: Event description (TEXT, NOT NULL)
- `category`: Event category (TEXT, NOT NULL)
- `eventDate`: Event date and time (TIMESTAMP(3), NOT NULL) - **mandatory field per AC**
- `photos`: Array of photo URLs (TEXT[])
- `createdAt`: Creation timestamp (TIMESTAMP(3), DEFAULT CURRENT_TIMESTAMP)
- `updatedAt`: Update timestamp (TIMESTAMP(3))
[Source: architecture/9-database-schema.md#Event Table]

### API Specifications
**tRPC Event Router**: Implementation must follow tRPC patterns with typed input/output validation
- Router location: `src/server/api/routers/event.ts`
- Must integrate with main router in `src/server/api/root.ts`
- **Required endpoints**:
  - `createEvent`: Mutation for creating new events
  - `updateEvent`: Mutation for updating existing events
  - `deleteEvent`: Mutation for deleting events
  - `getEvents`: Query supporting optional filtering (past/upcoming based on eventDate)
  - `getEvent`: Query for retrieving single event by ID
[Source: architecture/5-api-specification.md#Event Router]

### File Locations
- **Database Schema**: `prisma/schema.prisma` - Add Event model definition [Source: architecture/10-source-tree.md]
- **Event Router**: `src/server/api/routers/event.ts` - tRPC router implementation [Source: architecture/10-source-tree.md]
- **Main Router**: `src/server/api/root.ts` - Register event router [Source: architecture/10-source-tree.md]
- **Test Files**: `src/server/api/routers/event.test.ts` - Comprehensive API tests [Source: architecture/14-test-strategy-and-standards.md]

### Technical Constraints
- **TypeScript Strict Mode**: All API endpoints must have proper type safety [Source: architecture/13-coding-standards.md]
- **Prisma ORM**: All database access must use Prisma client - no direct SQL [Source: architecture/13-coding-standards.md]
- **tRPC Integration**: API must follow tRPC patterns for type-safe client-server communication [Source: architecture/2-tech-stack.md]
- **Environment Variables**: Database connection must be handled securely via environment variables [Source: architecture/13-coding-standards.md]
- **Error Handling**: Proper error responses and validation for all endpoints

### Database Technology
- **Database**: PostgreSQL 15+ [Source: architecture/2-tech-stack.md]
- **ORM**: Prisma 5+ for database operations [Source: architecture/2-tech-stack.md]
- **Migration**: Use Prisma migrate commands for schema changes

### Content Requirements for Future Events Frontend
**Static Recurring Events Content** (to be used in future Story 3.4):
- **Monthly Dhamma Discussion**: "Our signature monthly Dhamma Discussion is a cornerstone event held on the full moon Poya day, drawing over a hundred curious seekers of truth. The session begins with a profound talk by Mahaguru, followed by co-facilitated breakout discussions with Rev. Bhaddiya and Nevil Guru to explore the teachings more deeply." [Source: Project-Brief.md#Services Page Section 1]
- **Weekly Clarity Q&A**: "Join our interactive Weekly Clarity Q&A session, a supportive space for both new and experienced followers to find answers. Whether you have questions about your personal practice or seek to clarify concepts from our Dhamma discussions, this is your opportunity to engage directly with our facilitators. The session is expertly guided by Rev. Dodangoda Bhaddiya and Nevil Guru, with Mahaguru often in attendance to provide deeper insights where needed." [Source: Project-Brief.md#Services Page Section 5]

**Event System Requirements Context**:
- Events page must display both static recurring events and dynamic admin-managed events [Source: prd/5-epic-story-breakdown.md#Story 3.4]
- System must automatically filter events into "Upcoming Events" and "Past Events Archive" based on eventDate [Source: prd/2-requirements.md#FR3]
- Dynamic events must include Name, Description, Category, Date, and Photos [Source: prd/2-requirements.md#FR2]

### Project Structure Notes
The event router will be the first tRPC router implementation. The existing project structure supports this with the `src/server/api/routers/` directory already defined. Database schema will be added to the existing `prisma/schema.prisma` file. No structural conflicts identified with the established Next.js app directory architecture.

### Testing
- **Framework**: Vitest for unit and integration testing [Source: architecture/14-test-strategy-and-standards.md]
- **Coverage Target**: 80% code coverage for critical logic [Source: architecture/14-test-strategy-and-standards.md]
- **Test Strategy**: Focus on API endpoint functionality, validation, and error handling [Source: architecture/14-test-strategy-and-standards.md]
- **Test Location**: `src/server/api/routers/event.test.ts` for API router tests
- **Database Testing**: Use test database or in-memory database for isolation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
GitHub Copilot - Full Stack Developer

### Debug Log References
- Database migration created successfully: `20250920071146_initial_setup`
- All TypeScript compilation passed without errors
- Linting warnings resolved for unused imports
- Test suite: 13 tests passed with 100% success rate

### Completion Notes
- ✅ Event model successfully added to Prisma schema with all required fields
- ✅ Database migration executed successfully, Event table created
- ✅ Complete tRPC Event Router implemented with all CRUD operations
- ✅ Input validation using Zod schemas for type safety
- ✅ Event filtering by past/upcoming based on eventDate vs current timestamp
- ✅ Comprehensive test suite with 13 test cases covering validation and logic
- ✅ All acceptance criteria met and verified
- ✅ Code follows TypeScript strict mode and project coding standards
- ✅ Router integrated into main tRPC router for client access

### File List
**New Files Created:**
- `src/server/api/routers/event.ts` - tRPC Event Router with CRUD operations
- `src/server/api/routers/event.test.ts` - Comprehensive test suite
- `prisma/migrations/20250920071146_initial_setup/migration.sql` - Database migration

**Modified Files:**
- `prisma/schema.prisma` - Added Event model with required fields
- `src/server/api/root.ts` - Added eventRouter to main tRPC router

## QA Results

### Review Date: September 20, 2025

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**EXCELLENT** - This implementation demonstrates exemplary full-stack development practices. The Event API foundation is production-ready with comprehensive type safety, proper validation, and robust testing. All architecture patterns and coding standards are correctly followed.

### Refactoring Performed

No refactoring was required. The implementation is clean, well-structured, and follows all established patterns correctly.

### Compliance Check

- **Coding Standards**: ✓ Full compliance with TypeScript strict mode, ESLint, and Prettier
- **Project Structure**: ✓ Perfect adherence to established tRPC and Prisma patterns  
- **Testing Strategy**: ✓ Comprehensive test coverage with 13 test cases covering all scenarios
- **All ACs Met**: ✓ All 7 acceptance criteria fully implemented and verified

### Requirements Traceability Analysis

**AC1 - Database Schema**: ✓ Event table created with proper Prisma model and migration executed
**AC2 - Mandatory EventDate**: ✓ eventDate field implemented as required DateTime with NOT NULL constraint
**AC3 - CRUD Endpoints**: ✓ Complete tRPC router with createEvent, updateEvent, deleteEvent mutations
**AC4 - Filtering Support**: ✓ getEvents query supports past/upcoming filtering based on eventDate comparison
**AC5 - Single Event Retrieval**: ✓ getEvent query implemented for individual event access by ID
**AC6 - Automated Testing**: ✓ 13 comprehensive test cases with 100% pass rate covering validation and logic
**AC7 - Complete Data Model**: ✓ All required fields (name, description, category, eventDate, photos) included

### Test Architecture Assessment

**EXCELLENT** - Testing approach is comprehensive and well-designed:
- **Input Validation Tests**: Covers all Zod schema validation scenarios
- **Business Logic Tests**: Validates date filtering logic with temporal comparisons
- **Error Handling**: Tests include validation failure scenarios
- **Coverage**: 13 test cases covering create, update, delete, filter, and validation logic
- **Test Design Quality**: Tests are isolated, deterministic, and follow AAA pattern

### Improvements Checklist

All items completed successfully:
- [x] Event model added to Prisma schema with all required fields
- [x] Database migration executed successfully
- [x] Complete tRPC Event Router implemented with type-safe CRUD operations
- [x] Input validation using Zod schemas for comprehensive type safety
- [x] Event filtering by past/upcoming using eventDate timestamp comparison
- [x] Router integrated into main tRPC router for client access
- [x] Comprehensive test suite covering all endpoints and edge cases

### Security Review

**PASS** - Proper security measures implemented:
- Input validation prevents injection attacks through Zod schemas
- Admin operations properly protected with protectedProcedure
- Public queries use publicProcedure appropriately
- No sensitive data exposure identified
- Database access follows secure Prisma patterns

### Performance Considerations

**OPTIMIZED** - Performance best practices implemented:
- Database index on eventDate field for efficient filtering
- Efficient query patterns with proper WHERE clauses
- Optimized ordering (desc for past, asc for upcoming)
- Clean data handling without unnecessary processing

### Non-Functional Requirements Validation

**Security**: ✓ PASS - Proper authentication boundaries and input validation
**Performance**: ✓ PASS - Optimized queries with appropriate indexing
**Reliability**: ✓ PASS - Comprehensive error handling and validation
**Maintainability**: ✓ PASS - Clean TypeScript code with excellent type safety
**Testability**: ✓ PASS - Excellent test coverage and maintainable test design

### Files Modified During Review

No files were modified during review - implementation was already optimal.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.1-events-backend-api-foundation.yml

### Recommended Status

✅ **Ready for Done** - All acceptance criteria met, comprehensive testing complete, production-ready implementation.